import { Divider, Grid, Typography } from '@material-ui/core';
import PropTypes from 'prop-types';
import { useEffect, useState } from 'react';
import IMG from 'react-graceful-image';
import { Link } from 'react-router-dom';
import VisibilitySensor from 'react-visibility-sensor';
import { Class } from 'services/goStalk';
import userService from 'services/user';
import styles from './PeopleSearchResult.module.css';

/*Const string was created with https://png-pixel.com/ .
 *It is a 1 x 1 pixel with the same color as gordonColors.neutral.lightGray (7/9/21)
 *Although this doesn't use the gordonColors themes directly,
 *the end result is much cleaner and faster than using the placeholderColor tag of react-graceful-image.
 */
const GORDONCOLORS_NEUTRAL_LIGHTGRAY_1X1 =
  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mN8/erVfwAJRwPA/3pinwAAAABJRU5ErkJggg==';
const JPG_BASE64_HEADER = 'data:image/jpg;base64,';

const PeopleSearchResult = ({ Person, size, lazyImages }) => {
  const [avatar, setAvatar] = useState(GORDONCOLORS_NEUTRAL_LIGHTGRAY_1X1);
  const [hasBeenRun, setHasBeenRun] = useState(false);
  const [fullName, setFullName] = useState('');
  const [nickname, setNickname] = useState('');
  const [personClassJobTitle, setPersonClassJobTitle] = useState('');
  const [personMailLocation, setPersonMailLocation] = useState('');
  const [maidenName, setMaidenName] = useState();
  const SecondaryText = ({ children, otherProps }) => (
    <Typography variant="body2" color="textSecondary" {...otherProps}>
      {children}
    </Typography>
  );

  useEffect(() => {
    if (lazyImages === false) {
      loadAvatar();
    }
  });

  useEffect(compileInfo);

  async function loadAvatar() {
    //Rename def to defaultImage and pref to preferredImage for clarity
    const { def: defaultImage, pref: preferredImage } = await userService.getImage(
      Person.AD_Username,
    );

    if (Person.AD_Username) {
      setAvatar(JPG_BASE64_HEADER + (preferredImage || defaultImage));
    }
    setHasBeenRun(true);
  }

  function handleVisibilityChange(isVisible) {
    if (isVisible && !hasBeenRun) loadAvatar();
  }

  function compileInfo() {
    setFullName(Person.FirstName + ' ' + Person.LastName);

    // set nicknames up
    if (Person.NickName && Person.FirstName !== Person.NickName) {
      setNickname('(' + Person.NickName + ')');
    }
    // set maiden names up
    if (Person.MaidenName && Person.LastName !== Person.MaidenName) {
      setMaidenName('(' + Person.MaidenName + ')');
    }
    // set classes up
    if (Person.Type === 'Student') {
      setPersonClassJobTitle(Class[Person.Class]);
    } else if (Person.JobTitle && Person.Type !== 'Student') {
      setPersonClassJobTitle(Person.JobTitle);
    }
    // set mailbox up
    if (Person.Mail_Location) {
      setPersonMailLocation(
        Person.Type === 'Student'
          ? 'Mailbox #' + Person.Mail_Location
          : 'Mailstop: ' + Person.Mail_Location,
      );
    }
  }

  return (
    <VisibilitySensor onChange={handleVisibilityChange}>
      <>
        <Divider />
        {size === 'single' /*** Single Size - One Column (Mobile View) ***/ ? (
          <Link className="gc360_link" to={`profile/${Person.AD_Username}`}>
            <Grid
              container
              alignItems="center"
              justifyContent="center"
              spacing={2}
              style={{
                padding: '1rem',
              }}
            >
              <Grid item>
                <IMG
                  className={styles.people_search_avatar_mobile}
                  src={avatar}
                  alt={'Profile picture for ' + fullName}
                  noLazyLoad="true"
                  noPlaceHolder="true"
                />
              </Grid>
              <Grid item xs={8}>
                <Typography variant="h5">
                  {Person.FirstName} {nickname} {Person.LastName} {maidenName}
                </Typography>
                <SecondaryText>
                  {personClassJobTitle ?? Person.Type}
                  {Person.Type === 'Alum' && Person.PreferredClassYear
                    ? ' ' + Person.PreferredClassYear
                    : null}
                </SecondaryText>
                <SecondaryText>
                  {Person.Major1Description}
                  {Person.Major2Description
                    ? (Person.Major1Description ? ', ' : '') + `${Person.Major2Description}`
                    : null}
                  {Person.Major3Description ? `, ${Person.Major3Description}` : null}
                </SecondaryText>
                <SecondaryText variant="body2">{Person.Email}</SecondaryText>
                <SecondaryText variant="body2">{personMailLocation}</SecondaryText>
              </Grid>
            </Grid>
          </Link>
        ) : size === 'largeImages' /*** Enlarged Images ***/ ? (
          <Link className="gc360_link" to={`profile/${Person.AD_Username}`}>
            <Grid
              container
              alignItems="center"
              justifyContent="center"
              spacing={2}
              style={{
                padding: '1rem',
              }}
            >
              <Grid item xs={4} container justifyContent="flex-end">
                <IMG
                  className={styles.people_search_avatar_large}
                  src={avatar}
                  alt={'Profile picture for ' + fullName}
                  noLazyLoad="true"
                  noPlaceHolder="true"
                />
              </Grid>
              <Grid item xs={8}>
                <Typography variant="h5">
                  {Person.FirstName} {nickname} {Person.LastName} {maidenName}
                </Typography>
                <SecondaryText>
                  {personClassJobTitle ?? Person.Type}
                  {Person.Type === 'Alum' && Person.PreferredClassYear
                    ? ' ' + Person.PreferredClassYear
                    : null}
                </SecondaryText>
                <SecondaryText>
                  {Person.Major1Description}
                  {Person.Major2Description
                    ? (Person.Major1Description ? ', ' : '') + `${Person.Major2Description}`
                    : null}
                  {Person.Major3Description ? `, ${Person.Major3Description}` : null}
                </SecondaryText>
                <SecondaryText variant="body2">{Person.Email}</SecondaryText>
                <SecondaryText variant="body2">{personMailLocation}</SecondaryText>
              </Grid>
            </Grid>
          </Link> /*** Full Size - Multiple Columns (Desktop View) ***/
        ) : (
          <Link className="gc360_link" to={`profile/${Person.AD_Username}`}>
            <Grid
              container
              direction="row"
              alignItems="center"
              spacing={2}
              style={{
                padding: '1rem',
              }}
            >
              <Grid item xs={5} container alignItems="center">
                <IMG
                  className={styles.people_search_avatar}
                  src={avatar}
                  alt={'Profile picture for ' + fullName}
                  noLazyLoad="true"
                  noPlaceHolder="true"
                />
                <div>
                  <Typography>
                    {Person.FirstName} {nickname} {Person.LastName} {maidenName}
                  </Typography>
                  <Typography variant="subtitle2">
                    {Person.Email?.includes('.') ? Person.Email : null}
                  </Typography>
                </div>
              </Grid>
              <Grid item xs={5}>
                <Typography>
                  {personClassJobTitle ?? Person.Type}
                  {Person.Type === 'Alum' && Person.PreferredClassYear
                    ? ' ' + Person.PreferredClassYear
                    : null}
                </Typography>
                <SecondaryText>
                  {Person.Major1Description}
                  {Person.Major2Description
                    ? (Person.Major1Description ? ', ' : '') + `${Person.Major2Description}`
                    : null}
                  {Person.Major3Description ? `, ${Person.Major3Description}` : null}
                </SecondaryText>
              </Grid>
              <Grid item xs={2}>
                <Typography>{personMailLocation}</Typography>
              </Grid>
            </Grid>
          </Link>
        )}
        <Divider />
      </>
    </VisibilitySensor>
  );
};

// const PeopleSearchResult = handleViewport(PeopleSearchResultBlock);
export default PeopleSearchResult;

PeopleSearchResult.propTypes = {
  Person: PropTypes.shape({
    FirstName: PropTypes.string.isRequired,
    LastName: PropTypes.string.isRequired,
    Email: PropTypes.string.isRequired,
    AD_Username: PropTypes.string.isRequired,
    Nickname: PropTypes.string,
    Type: PropTypes.string.isRequired,
    Class: PropTypes.string,
    JobTitle: PropTypes.string,
    Mail_Location: PropTypes.string,
    PreferredClassYear: PropTypes.string,
    Major1Description: PropTypes.string,
    Major2Description: PropTypes.string,
    Major3Description: PropTypes.string,
  }).isRequired,
  size: PropTypes.string.isRequired,
  lazyImages: PropTypes.bool.isRequired,
};
